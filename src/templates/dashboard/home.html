{% extends "base.html" %}

{% block title %}管理者ダッシュボード{% endblock %}

{% block content %}
<h2>管理者ダッシュボード</h2>

{% if show_name %}
<p>表示モード：氏名あり</p>
{% else %}
<p>表示モード：匿名</p>
{% endif %}

<hr>

<h3>本日の集計</h3>
<p>
    <a href="?period=today">今日</a> |
    <a href="?period=month">今月</a>
</p>

<p>表示期間：{{ period }}</p>
<ul>
    <li>入力件数：{{ total_count }}</li>
    <li>出勤：{{ present_count }}</li>
    <li>欠勤：{{ absent_count }}</li>
</ul>
<h3>部署別 平均スコア</h3>

<table border="1">
    <tr>
        <th>部署</th>
        <th>平均（肉体）</th>
        <th>平均（精神）</th>
    </tr>

    {% for row in dept_stats %}
    <tr>
        <td>{{ row.user__employeeprofile__department }}</td>
        <td>{{ row.avg_physical|floatformat:1 }}</td>
        <td>{{ row.avg_mental|floatformat:1 }}</td>
    </tr>
    {% endfor %}
</table>
<hr>

<h3>月次推移（平均スコア）</h3>
<canvas id="monthlyChart"></canvas>

<table border="1">
    <tr>
        <th>月</th>
        <th>平均（肉体）</th>
        <th>平均（精神）</th>
        <th>入力件数</th>
    </tr>

    {% for row in monthly_stats %}
    <tr>
        <td>{{ row.month|date:"Y-m" }}</td>
        <td>{{ row.avg_physical|floatformat:1 }}</td>
        <td>{{ row.avg_mental|floatformat:1 }}</td>
        <td>{{ row.count }}</td>
    </tr>
    {% endfor %}
</table>
<hr>
<h3>ご意見箱（タグ別件数）</h3>

{% if tag_counts %}
<ul>
    {% for tag, count in tag_counts.items %}
    <li>{{ tag }}：{{ count }} 件</li>
    {% endfor %}
</ul>
{% else %}
<p>現在、ご意見の投稿はありません。</p>
{% endif %}
<hr>
<h3>ご意見箱 集計</h3>

{% if tag_counts %}
<table border="1">
    <tr>
        <th>タグ</th>
        <th>件数</th>
    </tr>
    {% for tag, count in tag_counts.items %}
    <tr>
        <td>{{ tag }}</td>
        <td>{{ count }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>※ 現在、集計対象の投稿はありません。</p>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById("monthlyChart");
    if (ctx) {
        const labels = JSON.parse('{{ months_json|escapejs }}');
        const physical = JSON.parse('{{ avg_physical_json|escapejs }}');
        const mental = JSON.parse('{{ avg_mental_json|escapejs }}');

        new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    { label: "肉体スコア（平均）", data: physical },
                    { label: "精神スコア（平均）", data: mental },
                ],
            },
        });
    }
</script>
{% endblock %}