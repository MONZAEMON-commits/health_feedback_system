# 6. システムフロー（System Flow）

本章では、各機能の処理順序・分岐・責務分担を  
**時系列で理解できるように整理**する。

UI 操作・DB 更新（体調管理データのみ）・CSV 参照を  
**実装に直結する粒度**で示し、  
権限差・例外処理・将来拡張はフロー上で明確に分離する。


## 6.1 一般社員の入力フロー

```text
[ログイン]
　　↓
[体調入力画面表示]
　　↓
（肉体・精神の 1〜5 のアイコンを選択）
　　↓
[登録ボタン押下]
　　↓
[確認テキストボックス表示]
　　↓
（再確認 → 登録確定）
　　↓
[SQLite に保存]
　　↓
[入力完了画面]
　　↓ 60秒無操作
[自動ログアウト]
```

---

## 6.2 欠勤処理フロー（一般社員）

```text
[ログイン]
　　↓
[欠勤を選択]
　　↓
[欠勤＝true で登録]
（physical/mental は NULL）
　　↓
[完了画面 → 自動ログアウト]
```

---

## 6.3 ご意見箱（PHP）フロー

### 6.3 ご意見箱（PHP）フロー（更新後）

本フローは Django 側のログイン後に実行され、  
employee_id を引き継いだ状態で遷移する。

---

### 6.3.1 投稿モード選択（index.php）

```text
[index.php]
　　↓
（匿名／準匿名／署名 のいずれかを選択）
　　↓
[次へボタン]
　　↓
[form.php]
```

- Django から employee_id を GET で受け取る  
- ラジオボタンで投稿形式（mode）を選択  
- employee_id と mode を POST で form.php に送信する

---

### 6.3.2 入力 → 確認 → 投稿（form.php → confirm.php → submit.php）

```text
[form.php]
　　↓
（意見入力・タグ選択）
　　↓
[confirm.php]
（内容確認）
　　↓
[submit.php]
（CSV に追記保存）
　　↓
[success.php]
（5秒後に Django ログイン画面へ遷移）
```
- content と tag は必須入力  
- employee_id と mode は hidden で引き回す  
- submit.php で CSV 追記後、success.php へ遷移する  
- success.php は 5 秒後に Django のログイン画面へ戻る

---

## 6.4 Django 管理者レベル1（個人が見える管理者）

### 6.4.1 ダッシュボード閲覧

```text
[管理者ログイン]
　　↓
[ダッシュボード]
　　↓
（フィルタ：期間 / 部署 / 対象外を除外）
　　↓
[個人データ閲覧可]
　　↓
[グラフ表示]
　　↓ 無操作1〜60分
[自動ログアウト]
```

---

## 6.5 Django 管理者レベル2（匿名閲覧者）

### 6.5.1 匿名化ダッシュボード

```text
[管理者ログイン]
　　↓
[ダッシュボード（匿名化表示）]
　　↓
（個人名なし・部署単位拡大）
　　↓
[統計情報確認]
　　↓ 無操作1〜60分
[自動ログアウト]
```

---

## 6.6 データ分析フロー（Django pandas）

```text
[analysis モジュール起動]
　　↓
[SQLite条件データ読み込み]
　　↓
[CSVご意見データ読み込み]
　　↓
[pandas で加工・集計]
　　↓
[統計値出力]
　　↓
[管理者画面へ反映（dashboard）]
```

---

## 6.7 バックアップフロー（週次）

```text
[スケジュールされた処理開始（週1）]
　　↓
[SQLite → db_backup_YYYYMMDD.sqlite3]
　　↓
[CSV    → opinion_backup_YYYYMMDD.csv]
　　↓
[バックアップフォルダへ保存]
```

---

## 6.8 例外フロー

### ● 入力中断
- 確定前にログアウトした場合 → **保存されない**

### ● ネットワーク切断
- 入力確定前ならデータは破棄  
- 確定後なら DB が「created_at」で正しく保存

### ● データ破損
- バックアップ（週次）から復元可能

---

## 6.9 全体フロー図（簡易統合）

```text
一般社員：ログイン → 入力 → 確認 → 保存 → 完了  
管理者1：ログイン → 統計（実名） → 分析 → 自動ログアウト  
管理者2：ログイン → 統計（匿名） → 傾向確認 → 自動ログアウト  
PHP：モード選択 → 入力 → 確認 → CSV保存 → 完了  
分析：SQLite + CSV 読込 → pandas処理 → 管理画面へ出力
```

