# 9. セキュリティ設計（Security Policy）

本章では、体調管理システム（Django）およびご意見箱（PHP）における  
セキュリティ要件を体系的にまとめる。

本システムは “社員の健康情報” という **要配慮データに近い情報** を扱うため、  
最低限の保護ではなく **現実的に守れる強固な構成** を採用する。

---

## 9.1 全体方針

### ● A. Django（体調管理）：強制ログイン・権限管理あり  
- IC カード or ID/パスワードで認証  
- 権限レベル（管理者レベル1／管理者レベル2）で画面アクセス制御  
- 管理者画面にはタイムアウト機能を実装（1～60分で可変）

### ● B. PHP（ご意見箱）：基本的にログイン不要  
- 匿名投稿の利便性を最優先  
- ※ただし署名投稿の個人情報は PHP 側で保持しない  
- CSV に保存し、Django 側で必要な部分のみ分析へ利用する

PHP 側では、匿名・準匿名・署名のいずれの投稿形式においても、  
氏名・部署・性別・年代などの個人属性情報を恒久的に保持しない。  
投稿時に扱うのは employee_id を含む最小限の識別情報のみとし、  
個人属性の補完・管理はすべて Django 側で行う設計とする。

### ● C. データ通信はローカル前提  
- URL 公開はせず、開発環境でのみ動作させる  
- 実務を想定したセキュリティを保ちつつも  
  初学者の構築負担を増やさない方針とする

---

## 9.2 アクセス制御（Django 側）

### ● 権限レベルとアクセス範囲

| レベル | 名称          | 主な利用者 | 許可される操作                       |
| ------ | ------------- | ---------- | ------------------------------------ |
| 0      | 一般社員      | 一般社員   | 体調入力・履歴確認                   |
| 1      | 管理者レベル1 | 担当者     | 部署別統計閲覧                       |
| 2      | 管理者レベル2 | 管理者     | 全体統計／設定変更／タイムアウト設定 |

### ● 実装方法
- Django の認証フレームワークを使用
- `User` + `Group` で権限を付与
- URL へのアクセスは `@login_required` と `@permission_required` を使用

---

## 9.3 入力チェック

### ● Django（体調入力）
- スコア（1〜5）の範囲チェック  
- 日付重複登録の防止  
- 不正値（文字列・負数）の排除  
- 欠勤時はスコア未入力（NULL）を許容  

### ● PHP（ご意見箱）
- 必須項目チェック（本文・タグ）  
- 署名モードの氏名・部署も必須  
- 不正な文字列を `htmlspecialchars()` でエスケープ  
- 連続投稿は禁止（短期間の連投はブロック可能）

署名モードにおいても、PHP 側で氏名や部署を入力・保存することは行わない。  
「署名」とは Django 側で employee_id をキーに個人を識別できることを意味し、  
PHP 側では投稿内容と識別子のみを扱う。

---

## 9.4 XSS 対策

### ● Django
- テンプレートは自動エスケープ  
- 表示前に危険タグを除外  
- 管理者画面のフィールドもサニタイズ  

### ● PHP
- すべてのユーザー入力に `htmlspecialchars()` を適用  
- JS を使う場合も DOM 操作部分を最小限にする  

---

## 9.5 CSRF 対策

### ● Django
- Django 標準の `{% csrf_token %}` を使用  
- POST 以外のフォームは生成しない  
- 一般社員と管理者画面の双方で対策有効  

### ● PHP
- POST メソッドのみを受け付ける  
- 必須パラメータの存在チェックを行う  
- 直接 URL アクセスはエラーとして処理する  

---

## 9.6 セッション管理（タイムアウト）

### ● 体調管理システム（Django）
- 無操作タイマー（管理者画面のみ）  
- 1〜60分の範囲で設定可能  
- 管理者アカウントのみ設定変更可能  
- 設定値は DB に保存  

### ● ご意見箱（PHP）
- 匿名で使えるためセッション不要  
- 署名投稿でもセッションは短時間（最小限）  

PHP 側のセッションは画面遷移制御のための一時利用に限定し、  
個人情報や分析対象となる属性データを保持する用途では使用しない。【注釈】

---

## 9.7 ファイル・データ保護

### ● CSV（ご意見箱データ）
- `opinions/` フォルダはブラウザからアクセス不可（.htaccess）  
- 書き込み時は排他制御を実施  
- 日本語文字化け防止のため UTF-8 で統一  

### ● Django DB
- 社員データ・健康データは DB に保存  
- パスワードはハッシュ化（PBKDF2）  
- 退職社員は `is_active` フラグで無効化  

---

## 9.8 バックアップ（週次）

### ● 対象  
- Django DB（SQLite or PostgreSQL）  
- PHP の意見 CSV（opinion_box.csv）

### ● 方法  
- 週次で自動バックアップ  
- 系統は「日付付きファイル名」で保存  
- ディレクトリ例：

```text
backups/
├── db_2025-01-01.sqlite3
├── opinions_2025-01-01.csv
└── ...
```

### ● 拡張（任意）
- 毎日バックアップ  
- 外部ストレージ（NAS/Cloud）への自動出力  

---

## 9.9 ログ管理

### ● Django 側
- ログイン成功／失敗  
- 管理者操作（設定変更・タイムアウト変更）  
- CSV 読み取りエラー  

### ● PHP 側
- 投稿エラー  
- CSV 書込みエラー  

ログは開発時のみ出力し、実務では外部転送も可能。

---

## 9.10 セキュリティテスト項目

| No  | 内容                     | 対象       | 期待結果             |
| --- | ------------------------ | ---------- | -------------------- |
| 1   | 不正ログイン試行         | Django     | ログが残り、認証失敗 |
| 2   | 無操作タイマー動作       | Django     | 指定時間でログアウト |
| 3   | XSS テスト               | Django/PHP | 危険タグが無効化     |
| 4   | CSRF 相当の直接 POST     | PHP        | 投稿できない         |
| 5   | CSV インジェクション文字 | PHP        | 自動エスケープ       |
| 6   | ファイル権限変更テスト   | PHP        | 直接アクセス不可     |
| 7   | 異常データ行の読み取り   | Django     | スキップ処理         |

---

## 9.11 まとめ

本システムのセキュリティは以下の方針で保護される：

- Django と PHP の責務分離  
- 権限レベルによる健康情報の保護  
- 匿名投稿の安全性確保  
- CSRF・XSS 対策の実装  
- 処理の単純化による安全性向上  
- ログとバックアップでの運用対策  

