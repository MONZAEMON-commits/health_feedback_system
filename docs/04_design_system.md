# 4. 全体設計（Design System）

本章では、本システムの全体アーキテクチャ・UI方針・バックエンド構造・  
PHPご意見箱モジュールとの連携方式を示す。  
体調管理（Django）とご意見箱（PHP）は **分離構造** を基本とし、  
CSV により連携する。

---

## 4.1 アーキテクチャ概要

本システムは以下の 3 層構造で設計する。

### ● Presentation Layer（UI/画面）
- HTML / CSS  
- レスポンシブ対応（アイコン自動段組み）
- JavaScript は最小限の利用（バリデーション程度）

### ● Application Layer（アプリケーション）
- Django（体調管理）  
  - 認証・入力処理・分析・集計・管理者画面
- PHP（ご意見箱）  
  - 投稿処理・確認画面・CSV保存

### ● Data Layer（データ）
- Django → SQLite（体調データ）
- PHP → CSV（意見投稿データ）
- pandas → 分析用に DB + CSV を読み込み

---

## 4.2 ディレクトリ構成

```text
project/
├── src/                     ← Django
│   ├── manage.py
│   ├── core/                ← 共通設定
│   ├── accounts/            ← 認証
│   ├── conditions/          ← 体調管理アプリ
│   ├── dashboard/           ← 管理者画面
│   ├── analysis/            ← pandas 分析
│   └── templates/           ← HTMLテンプレ
│
├── php_opinion_box/         ← ご意見箱(PHP)
│   ├── index.php            ← 投稿形式選択
│   ├── form.php             ← 入力画面
│   ├── confirm.php          ← 確認画面
│   ├── submit.php           ← CSV保存
│   ├── success.php          ← 完了画面
│   ├── css/style.css
│   ├── js/validation.js
│   └── opinions/opinion_box.csv
│
└── docs/                    ← 設計書
```

---

## 4.3 画面設計（UI Design）

### 4.3.1 一般社員：体調入力画面

- 肉体・精神の 1〜5 アイコンを表示  
- 表示段数は画面幅で自動切替（1段 or 2段）  
- 「登録」ボタンで確認テキストボックスが開く  
- 確定後、完了画面へ遷移 → 10秒無操作で自動ログアウト  
- ご意見箱への導線アイコンを配置（任意）

### 4.3.2 管理者画面

- 統計ダッシュボード表示  
- レベル1 → 氏名あり  
- レベル2 → 匿名化表示  
- グラフ描画は Django + （必要なら Chart.js 併用）  
- 無操作 1〜60分で自動ログアウト（設定可能）

### 4.3.3 ご意見箱画面（PHP）

- モード選択：匿名／準匿名／署名  
- 説明を表示し、続行ボタンで入力画面へ  
- タグ（カテゴリ）必須選択（分類分析用）  
- 確認画面 → 投稿 → CSV保存  
- 完了画面で 5 秒後自動リダイレクト

---

## 4.4 Django モジュール設計

### 4.4.1 accounts（認証）
- Django 標準の User を使用  
- ログイン／ログアウト  
- 自動ログアウト（タイマー実装）  
- 管理者レベル（1 / 2）を User に紐付ける

### 4.4.2 conditions（体調管理）
- 当日入力・確認・登録  
- 欠勤＝NULL 処理  
- アイコン入力ロジック  
- 入力完了 → 自動ログアウト

### 4.4.3 dashboard（管理者画面）
- 集計ロジック（pandas + ORM）  
- 表示フィルタ（期間 / 部署 / 対象外フラグ）  
- レベル1：氏名表示  
- レベル2：匿名表示  
- グラフ描画（Chart.js 使用可）

### 4.4.4 analysis（データ分析）
- pandas によるデータ整理  
- DB（SQLite）＋ CSV（PHP）両方を読み込み  
- 統計ラベル付け（平均/中央値/変動）  
- 将来の AI 分析モデル追加を見据えた構造

---

## 4.5 ご意見箱（PHP）モジュール設計

### 4.5.1 構成概要

```text
php_opinion_box/
├── index.php        ← 投稿モード選択
├── form.php         ← 入力フォーム
├── confirm.php      ← 確認画面
├── submit.php       ← CSV保存処理
├── success.php      ← 完了画面
├── css/style.css
├── js/validation.js
└── opinions/opinion_box.csv
```

### 4.5.2 投稿形式

| 形式   | 内容                         | 取得する情報      |
| ------ | ---------------------------- | ----------------- |
| 匿名   | 完全匿名で投稿               | 不要              |
| 準匿名 | 性別・年代を付与             | gender, age_range |
| 署名   | 氏名・部署・性別・年齢を付与 | 全情報            |

### 4.5.3 CSV 保存仕様

```csv
timestamp, mode, gender, age, department, content, tag
2025-01-01 10:00, 匿名, -, -, -, "〜〜〜〜", "業務改善"
2025-01-01 10:05, 署名, 女性, 29, 開発, "〜〜〜〜", "安全性"
```

---

## 4.6 データ連携設計（CSV / DB）

### ● Django → SQLite
- 体調データ（社員ID・日付・スコア）を保存  
- 欠勤は NULL  
- is_target フラグで対象外社員を除外

### ● PHP → CSV
- ご意見投稿を追記  
- pandas で定期的に分析可能

### ● Django（analysis モジュール）
- SQLite + CSV の両方を読み込む  
- 統計分析（平均、中央値、分布、変動）  
- 管理者画面へ結果出力

---

## 4.7 自動ログアウト（セキュリティ）

### ● 一般社員
- 10 秒無操作で自動ログアウト  
- 日付表示あり

### ● 管理者
- 1〜60分の範囲で設定可能  
- 操作が行われたらタイマーリセット  
- 設定値は Django の管理画面で変更可能

---

## 4.8 バックアップ設計

### ● 対象
- SQLite DB  
- ご意見 CSV

### ● 頻度
- 週 1 回（標準）  
- 日次は拡張

### ● 保存形式
```text
backup/
├── db_backup_YYYYMMDD.sqlite3
└── opinion_backup_YYYYMMDD.csv
```

---

## 4.9 例外処理設計

- 入力中断 → 未保存扱い（翌朝ログインで再入力）  
- 欠勤 → NULL（集計除外）  
- データ破損 → バックアップから復元  
- 投稿モード選択ミス → 再選択画面へ戻る  

---

## 4.10 拡張性設計

- AI 解析（異常検知アルゴリズムの追加）  
- 勤怠データ取り込み（外部 CSV）  
- クラウド移行（AWS / GCP）  
- 本番 DB（MySQL/PostgreSQL）対応  

