# 5. データベース設計（DB Design）

本章では Django（体調管理）で使用する SQLite データベースの構造を定義する。  
ご意見箱（PHP）は CSV を使用するため、DB には含めない。

---

## 5.1 ER 図（概念データモデル）

```text
Users (社員情報)
│ 1
│
└───∞ Conditions (体調入力)
```

※ ご意見箱（PHP）は DB 非使用のため ER 図には含めない。

---

## 5.2 テーブル一覧

| テーブル名        | 用途                                   |
| ----------------- | -------------------------------------- |
| users             | 社員基本情報（Django 標準 User 拡張）  |
| employee_profiles | 社員詳細（性別・部署・年齢など）       |
| conditions        | 日次体調入力（肉体・精神・タグ含む）   |
| system_settings   | 管理者用設定（自動ログアウト時間など） |

---

## 5.3 users（Django 標準）＋管理者レベル拡張

### ● 用途  
- ログイン・認証  
- 権限（一般 / 管理者1 / 管理者2）を付与

### ● フィールド

| フィールド名 | 型      | 説明                                     |
| ------------ | ------- | ---------------------------------------- |
| id           | int     | 主キー                                   |
| username     | varchar | ログインID                               |
| password     | varchar | パスワード（ハッシュ）                   |
| is_staff     | bool    | Django 標準管理者フラグ                  |
| role_level   | int     | 0=一般, 1=管理者レベル1, 2=管理者レベル2 |

---

## 5.4 employee_profiles（社員詳細情報）

### ● 用途  
- 性別・年齢・部署など、体調データと分析で使用する情報を保持  
- 「集計対象外」フラグもここで管理

### ● フィールド

| フィールド名 | 型           | 説明                                   |
| ------------ | ------------ | -------------------------------------- |
| user_id      | FK(users.id) | User との 1対1                         |
| full_name    | varchar      | 氏名                                   |
| gender       | varchar      | 男性 / 女性 / その他                   |
| age          | int          | 年齢（数値のみを正規データとして保持） |
| department   | varchar      | 部署名                                 |
| is_target    | bool         | 集計対象外フラグ（true＝対象外）       |

---

## 5.5 conditions（体調入力データ）

### ● 用途  
一般社員が入力した当日の体調を保持する。

### ● フィールド

| フィールド名 | 型           | 説明                                  |
| ------------ | ------------ | ------------------------------------- |
| id           | int          | 主キー                                |
| user_id      | FK(users.id) | 入力者                                |
| date         | date         | 入力日（1日1レコード）                |
| physical     | int          | 肉体スコア（1〜5）                    |
| mental       | int          | 精神スコア（1〜5）                    |
| created_at   | datetime     | 入力日時                              |
| is_absent    | bool         | 休みフラグ（休み＝true、出勤＝false） |
| notes        | text         | 備考（任意）                          |

### ● 休みの扱い  
- 休み日は is_absent = true  
- physical / mental / notes は **NULL**  
- 集計時に除外する

### ● 休み種別の将来拡張  
- 有給／欠勤など複数種別の細分化は将来拡張とする  

### ● 管理者による修正と履歴保持  
- 管理者は conditions の内容を修正可能とする  
- 修正履歴は保持可能な構造（例：履歴テーブル、監査ログ等）を想定する  
- 履歴保持の具体的なテーブル定義は本章では固定しない  

---

## 5.6 system_settings（システム設定）

### ● 用途  
- 管理者の自動ログアウト時間（1〜60分）を保持する  
- 管理画面で編集可能

### ● フィールド

| フィールド名          | 型  | 説明                          |
| --------------------- | --- | ----------------------------- |
| id                    | int | 主キー                        |
| admin_timeout_minutes | int | 管理者ログアウト時間（1〜60） |

---

## 5.7 ご意見箱（PHP）のデータ構造（CSV）

### ● DB ではなく CSV に保存  
Django 側で読み込む分析用ファイル。

```csv
timestamp,employee_id,mode,content,tag
2025-01-01 10:00,1,匿名,"〜〜〜〜","業務改善"
2025-01-01 10:05,2,準匿名,"〜〜〜〜","安全性"
2025-01-01 10:10,3,署名,"〜〜〜〜","環境改善"
```

### ● DB との突合キー  
- CSV の employee_id をキーに DB（users.id）と突合する  

---

## 5.8 今後の拡張性を見据えた設計方針

- DB を SQLite → PostgreSQL / MySQL に移行可能  
- user / employee_profiles を分割したことで柔軟性確保  
- conditions テーブルにタグ拡張可能  
- 意見箱は DB 化（別テーブル化）も容易  
- AI 解析用に教師データとして扱える構造  
