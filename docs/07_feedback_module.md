# 7. ご意見箱モジュール詳細設計（Feedback Module）

本章では、PHP で実装される「ご意見箱」機能の詳細仕様を定義する。  
本機能は Django 本体とは独立して動作し、CSV を介して連携する。

---

## 7.1 目的

- 社員が匿名・準匿名・署名のいずれかで自由に意見を投稿できる場を提供する  
- 投稿内容は職場改善や分析の基礎データとして活用できる  
- 匿名性と利便性を両立した UI/UX を実現する  
- Django 側に余計な依存を持たせない（CSV 連携）

---

## 7.2 構成概要

```text
php_opinion_box/
├── index.php        ← 投稿形式選択
├── form.php         ← 入力画面
├── confirm.php      ← 確認画面
├── submit.php       ← CSV保存処理
├── success.php      ← 完了画面
├── css/style.css
├── js/validation.js
└── opinions/opinion_box.csv
```
（追記）

【Django との連携仕様（employee_id）】
- Django 側でログイン後に取得した employee_id を、
  `index.php?id=xxxxx` のように URL パラメータとして受け取る。
- 受け取った employee_id は form.php → confirm.php → submit.php と
  hidden フィールドで引き継ぎ、CSV の employee_id カラムとして保存する。

---

## 7.3 投稿形式選択（index.php）

### ● 7.3.1 選択肢
| 種類   | 内容             | 取得情報               |
| ------ | ---------------- | ---------------------- |
| 匿名   | 完全匿名で投稿   | 取得なし               |
| 準匿名 | 年代・性別       | gender, age_range      |
| 署名   | 個人情報付き投稿 | 氏名・部署・年齢・性別 |

### ● 7.3.2 表示仕様  
- 3つのボタン（匿名／準匿名／署名）を横並びまたは縦並びで表示  
- 押下すると説明モーダル（または説明画面）を表示  
- 「進む」ボタンで `form.php` へ遷移

---

## 7.4 入力画面（form.php）

### ● 入力項目（モードによって変化）
| 項目             | 匿名 | 準匿名 | 署名 |
| ---------------- | ---- | ------ | ---- |
| 性別             | -    | ○      | ○    |
| 年代             | -    | ○      | ○    |
| 氏名             | -    | -      | ○    |
| 部署             | -    | -      | ○    |
| 意見本文         | ○    | ○      | ○    |
| タグ（カテゴリ） | ○    | ○      | ○    |

### ● タグ候補（初期案）
- 業務改善
- 人間関係
- 設備・環境
- 安全性
- その他

### ● 入力チェック  
- 空欄チェック（意見本文、タグ）  
- 署名モードで氏名・部署は必須  
- JS（軽量） もしくは PHP でサーバー側チェック

---

## 7.5 確認画面（confirm.php）

### ● 表示内容  
- 入力した内容をそのまま表示  
- モードごとに非表示項目は伏せる  
- 「戻る」「投稿する」ボタンを配置

### ● 処理仕様  
- 戻る → 再度入力画面へ  
- 投稿する → submit.php に送信

---

## 7.6 投稿処理（submit.php）

### ● 処理内容  
1. POST データ受取  
2. フォーマット整形  
3. CSV 書き込み（追記）  
4. success.php に遷移

### ● CSV 出力形式（１レコード）

```csv
timestamp, employee_id, mode, gender, age, department, content, tag
2025-01-01 10:00, E00123, 匿名, -, -, -, "意見内容", "業務改善"
```

---

## 7.7 完了画面（success.php）

### ● 表示内容  
- 「投稿が完了しました」  
- 5 秒後に `index.php` に自動リダイレクト  
- 手動で戻るボタンも設置

### ● 自動遷移  
- meta refresh または JS で実現  
- 体調入力完了画面とは異なり、ログアウト概念はない

---

## 7.8 セキュリティ対策

### ● CSRF  
- PHPフォームトークン利用（簡易）

### ● XSS  
- エスケープ処理  
- content カラムへのタグ混入を防止

### ● CSV インジェクション対策  
- 先頭が `=`, `+`, `-`, `@` の場合はエスケープする

---

## 7.9 例外処理

- 入力未完了 → CSV に保存しない  
- ファイル書込不可 → エラー画面へ  
- タグ未選択 → エラー表示  
- 入力欄に無効値 → 再入力要求

---

## 7.10 Django 側との連携仕様（読み込み処理）

### ● Django の analysis モジュールで実施  
- CSV を pandas で読み込む  
- 以下のようにデータ整形する：

```python
df = pd.read_csv("php_opinion_box/opinions/opinion_box.csv")
df["timestamp"] = pd.to_datetime(df["timestamp"])
分析用_df = df[["timestamp","mode","gender","age","department","tag"]]
```

### ● 分析結果の利用例  
- タグ別件数  
- 時間帯別傾向  
- 部署別意見傾向（署名のみ）  
- 性別・年代ごとの意見傾向（準匿名）  
- employee_id による社員単位の傾向分析  
  （部署・職種・勤続年数など、Djangoの社内DBと突き合わせて可視化可能）
- 匿名／準匿名／署名モードは mode カラムにより制御されるが、  
  employee_id は管理目的で常に保存されるため管理者側の内部分析に利用できる

